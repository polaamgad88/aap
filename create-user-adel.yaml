# playbooks/apply-htpasswd-policy.yml
- name: Apply Governance Policy for HTPasswd IdP and Cluster Admin
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Apply governance policy manifest
      k8s:
        state: present
        definition:
          apiVersion: policy.open-cluster-management.io/v1
          kind: Policy
          metadata:
            name: policy-htpasswd-adel-clusteradmin
            namespace: governance
          spec:
            disabled: false
            remediationAction: enforce
            policy-templates:
              - objectDefinition:
                  apiVersion: policy.open-cluster-management.io/v1
                  kind: ConfigurationPolicy
                  metadata:
                    name: cfg-htpasswd-secret-and-oauth
                  spec:
                    remediationAction: enforce
                    severity: high
                    object-templates:
                      - complianceType: musthave
                        objectDefinition:
                          apiVersion: v1
                          kind: Secret
                          metadata:
                            name: htpasswd-secret
                            namespace: openshift-config
                          type: Opaque
                          stringData:
                            htpasswd: |
                              adel:$2y$05$k67.Qy6iNazqZYjI79LyqutrG2DwifqwGN91ym71Wq1l3efuZQdmu
                      - complianceType: musthave
                        objectDefinition:
                          apiVersion: config.openshift.io/v1
                          kind: OAuth
                          metadata:
                            name: cluster
                          spec:
                            identityProviders:
                              - name: local-htpasswd
                                mappingMethod: claim
                                type: HTPasswd
                                htpasswd:
                                  fileData:
                                    name: htpasswd-secret
              - objectDefinition:
                  apiVersion: policy.open-cluster-management.io/v1
                  kind: ConfigurationPolicy
                  metadata:
                    name: cfg-cluster-admin-adel
                  spec:
                    remediationAction: enforce
                    severity: high
                    object-templates:
                      - complianceType: musthave
                        objectDefinition:
                          apiVersion: rbac.authorization.k8s.io/v1
                          kind: ClusterRoleBinding
                          metadata:
                            name: cluster-admin-adel
                          roleRef:
                            apiGroup: rbac.authorization.k8s.io
                            kind: ClusterRole
                            name: cluster-admin
                          subjects:
                            - kind: User
                              apiGroup: rbac.authorization.k8s.io
                              name: adel
    - name: Apply placement for targeting ManagedClusterSet set1
      k8s:
        state: present
        definition:
          apiVersion: cluster.open-cluster-management.io/v1beta1
          kind: Placement
          metadata:
            name: placement-set1
            namespace: governance
          spec:
            clusterSets:
              - set1
    - name: Apply placement binding for the policy
      k8s:
        state: present
        definition:
          apiVersion: policy.open-cluster-management.io/v1
          kind: PlacementBinding
          metadata:
            name: bind-htpasswd-adel
            namespace: governance
          placementRef:
            apiGroup: cluster.open-cluster-management.io
            kind: Placement
            name: placement-set1
          subjects:
            - apiGroup: policy.open-cluster-management.io
              kind: Policy
              name: policy-htpasswd-adel-clusteradmin
